{% extends "base.html" %}

{% block title %}Expert Availability{% endblock %}

{% block content %}
<h1 class="mt-5 mb-4 text-center">Update Weekly Availability</h1>
<div id="availability-form" class="container">
  <!-- Week Navigation -->
  {% set prev_week = week_start - timedelta(days=7) %}
  {% set next_week = week_start + timedelta(days=7) %}
  <div class="d-flex justify-content-center mb-3">
    {% if week_start > current_week_start %}
      <a href="{{ url_for('expert_page.update_availability') }}?week_start={{ prev_week.strftime('%Y-%m-%d') }}" class="btn btn-primary me-2">Previous Week</a>
    {% else %}
      <button type="button" class="btn btn-outline-secondary me-2" disabled>Previous Week</button>
    {% endif %}
    <a href="{{ url_for('expert_page.update_availability') }}?week_start={{ next_week.strftime('%Y-%m-%d') }}" class="btn btn-primary">Next Week</a>
  </div>
  
  <form action="{{ url_for('expert_page.update_availability') }}" method="POST" name="ExpertAvailability">
    <!-- CSRF token and hidden week_start field -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="week_start" value="{{ week_start.strftime('%Y-%m-%d') }}">
    
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Day</th>
          <th>Start Time (8:00 - 20:00)</th>
          <th>End Time (8:00 - 20:00)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for i in range(7) %}
          {% set current_day = week_start + timedelta(days=i) %}
          {% set availability = week_availabilities[current_day] %}
          <tr data-day="{{ current_day.strftime('%Y-%m-%d') }}">
            <td>{{ current_day.strftime('%A, %b %d') }}</td>
            <td>
              <input type="time" 
                     class="form-control start-input {% if current_day < today or (availability and not availability.status) %}bg-secondary text-white{% endif %}"
                     name="day_{{ i }}_start"
                     min="08:00" max="20:00"
                     value="{{ availability.start_time.strftime('%H:%M') if availability and availability.start_time else '' }}"
                     {% if current_day < today or (availability and not availability.status) %}disabled{% endif %}>
            </td>
            <td>
              <input type="time" 
                     class="form-control end-input {% if current_day < today or (availability and not availability.status) %}bg-secondary text-white{% endif %}"
                     name="day_{{ i }}_end"
                     min="08:00" max="20:00"
                     value="{{ availability.end_time.strftime('%H:%M') if availability and availability.end_time else '' }}"
                     {% if current_day < today or (availability and not availability.status) %}disabled{% endif %}>
            </td>
            <td>
              <select name="day_{{ i }}_status" 
                      class="form-control status-select"
                      {% if current_day < today %}disabled class="bg-secondary text-white"{% endif %}>
                <option value="available" {% if availability and availability.status %}selected{% endif %}>Available</option>
                <option value="unavailable" {% if availability and not availability.status %}selected{% endif %}>Unavailable</option>
              </select>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Mark Whole Week as Unavailable Button -->
    <div class="d-flex justify-content-center mt-2">
      <button type="button" id="mark-week-unavailable" class="btn btn-danger">
        Mark Whole Week as Unavailable
      </button>
    </div>

    <!-- Save Availability Button -->
    <div class="d-flex justify-content-center mt-3">
      <button type="submit" class="btn btn-primary">Save Availability</button>
    </div>
  </form>
</div>

<script src="{{ url_for('static', filename='js/timeValidation.js') }}"></script>
{% endblock %}
