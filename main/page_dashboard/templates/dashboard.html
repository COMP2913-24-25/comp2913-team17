{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Manager Dashboard -->
  {% if manager %}
  <h1>Management Dashboard</h1>

  <!-- Statistics Section -->
  <div class="card mt-4">
    <div class="card-header">
      <h2 class="mb-0">Management: Statistics</h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Total Revenue</h5>
              <p class="card-text">£{{ "%.2f" | format(manager['total_revenue']) }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Commission Income ({{ "%.2f" | format(manager['commission_percentage']) }}%)</h5>
              <p class="card-text">£{{ "%.2f" | format(manager['commission_income']) }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Active Auctions</h5>
              <p class="card-text">{{ manager['active_auctions'] }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Total Users</h5>
              <p class="card-text">{{ manager['user_count'] }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <h5>Revenue Over Time (Last 6 Months)</h5>
        <!-- Ensure data is properly serialized using tojson filter without any extra quotes -->
        <canvas id="revenueChart" width="400" height="200"
          data-labels='{{ manager["revenue_labels"]|tojson|safe }}'
          data-values='{{ manager["revenue_data"]|tojson|safe }}'
        ></canvas>
      </div>
    </div>
  </div>
  <!-- View Rota Button for managers -->
  <div class="my-3">
    <a href="{{ url_for('manager_page.expert_availability') }}" class="btn btn-primary">
      Availability Overview
    </a>
  </div>
  <!-- Manager User Role Interface -->
  {% if manager['users'] %}
  <div class="card mt-4">
    <div class="card-header">
      <h2 class="mb-0">Management: User Roles</h2>
    </div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Joined</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in manager['users'] %}
          <tr data-user-id="{{ user.id }}">
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td class="role-cell">{{ 'Expert' if user.role == 2 else 'User' }}</td>
            <td>{{ user.created_at.strftime('%a, %d %b %Y %H:%M:%S GMT') }}</td>
            <td class="updated-cell">{{ user.updated_at.strftime('%a, %d %b %Y %H:%M:%S GMT') }}</td>
            <td>
              <select class="form-select form-select-sm role-select" style="width: auto; display: inline-block;">
                <option value="1" {{ 'selected' if user.role == 1 else '' }}>User</option>
                <option value="2" {{ 'selected' if user.role == 2 else '' }}>Expert</option>
                <option value="3">Manager</option>
              </select>
              <button class="btn btn-sm btn-update update-role-btn my-sm-1">Update</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Management Configuration Section -->
  <div class="card mt-4">
    <div class="card-header">
      <h2 class="mb-0">Management: Configuration</h2>
    </div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>Option</th>
            <th>Current Value</th>
            <th>Update Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Base Platform Fee (%)</td>
            <td class="base-cell">{{ manager['base_fee'] }}</td>
            <td>
              <input type="number" class="form-control form-control-sm base-input" step="0.01" min="0.00" max="100.00" value="{{ manager['base_fee'] }}" style="width: auto; display: inline-block;">
              <button class="btn btn-sm btn-outline-primary update-base-btn my-sm-1">Update</button>
            </td>
          </tr>
          <tr>
            <td>Authenticated Item Fee (%)</td>
            <td class="auth-cell">{{ manager['authenticated_fee'] }}</td>
            <td>
              <input type="number" class="form-control form-control-sm auth-input" step="0.01" min="0.00" max="100.00" value="{{ manager['authenticated_fee'] }}" style="width: auto; display: inline-block;">
              <button class="btn btn-sm btn-outline-primary update-auth-btn my-sm-1">Update</button>
            </td>
          </tr>
          <tr>
            <td>Maximum Auction Duration (Days)</td>
            <td class="dur-cell">{{ manager['max_duration'] }}</td>
            <td>
              <input type="number" class="form-control form-control-sm dur-input" step="1" min="1" max="365" value="{{ manager['max_duration'] }}" style="width: auto; display: inline-block;">
              <button class="btn btn-sm btn-outline-primary update-dur-btn my-sm-1">Update</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Management: Pending Authentication Requests Section -->
  {% if manager['requests'] %}
  <div class="card mt-4">
    <div class="card-header">
      <h2 class="mb-0">Management: Pending Authentication Requests</h2>
    </div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>Requester</th>
            <th>Item</th>
            <th>Category</th>
            <th>Assign Expert</th>
          </tr>
        </thead>
        <tbody>
          {% for request, eligible_experts in manager['requests'] %}
          <tr data-request-id="{{ request.request_id }}">
            <td>{{ request.requester.username }}</td>
            <td><a href="/item/{{ request.item.url }}">{{ request.item.title }}</a></td>
            <td>
              <span class="badge bg-info p-2" {% if request.item.category.description %}title="{{ request.item.category.description }}"{% endif %}>
                <i class="fas fa-tag"></i> {{ request.item.category.name }}
              </span>
            </td>
            <td>
              {% if not eligible_experts %}
                <p>No available experts</p>
              {% else %}
                <select class="form-select form-select-sm expert-select" style="width: auto; display: inline-block;">
                  {% for expert in eligible_experts %}
                  <option value="{{ expert.id }}" data-availability="{{ get_expert_availability(expert) }}" data-expertise="{{ get_expertise(expert, request.item) }}">
                    {{ expert.username }}
                  </option>
                  {% endfor %}
                </select>
                <span class="availability-text ms-2"></span>
                <span class="badge bg-success p-2 expertise-text">
                  <i class="fas fa-tag"></i>
                </span>
                <button class="btn btn-sm btn-outline-primary assign-expert-btn my-sm-1">
                  Assign
                </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Expert Dashboard -->
  {% elif expert %}
  <h1>Expert Dashboard</h1>
  <div class="container mt-5">
    <h2>Expertise</h2>
    <!-- Current expertise -->
    <div class="card mb-4">
      <div class="card-header">Current Expertise</div>
        <div class="card-body">
          <div id="current-expertise">
            {% if expert['expertise'] %}
            {% for e in expert['expertise'] %}
            <span class="badge bg-primary me-2 mb-2" title="{{ e.description }}">{{ e.name }}</span>
            {% endfor %}
            {% else %}
            <p class="text-muted">No areas of expertise selected yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Category selection form -->
      <form id="expertise-form">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>All Categories</span>
            <div>
              <button type="button" id="select-all" class="btn btn-sm btn-outline-primary me-2">Select All</button>
              <button type="button" id="deselect-all" class="btn btn-sm btn-outline-secondary">Clear All</button>
            </div>
          </div>
          <div class="card-body">
            <div class="row" id="expertise-categories">
              {% for category in expert['categories'] %}
              <div class="col-md-4 col-sm-6 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" 
                    value="{{ category.id }}" 
                    id="category-{{ category.id }}" 
                    name="expertise" 
                    {% if category in expert['expertise'] %}checked{% endif %}>
                  <label class="form-check-label" for="category-{{ category.id }}" title="{{ category.description }}">
                    {{ category.name }}
                  </label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <!-- Chnage Expertise Buttons -->
        <div class="d-flex justify-content-end">
          <button type="button" id="cancel-changes" class="btn btn-outline-secondary me-2">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
    <!-- Authentications -->
    <h2>Pending Authentications</h2>
    {% if expert['pending'] %}
    <ul>
      {% for request in expert['pending'] %}
      <li>
        <a href="{{ url_for('item_page.index', url=request.authentication_request.item.url) }}" title="See item details">{{ request.authentication_request.item.title }}</a>
        <a href="{{ url_for('authenticate_item_page.index', url=request.authentication_request.url) }}" title="View authentication request" class="badge mx-2 {% if request.authentication_request.status == 1 %}bg-warning{% elif request.authentication_request.status == 2 %}bg-success{% else %}bg-danger{% endif %} p-2">
          {% if request.authentication_request.status == 1 %}Authentication Pending{% elif request.authentication_request.status == 2 %}Authenticated{% else %}Authentication Declined{% endif %}
        </a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>No auctions to authenticate.</p>
    {% endif %}
    <h2>Completed Authentications</h2>
      {% if expert['complete'] %}
      <ul>
        {% for request in expert['complete'] %}
        <li>
          <a href="{{ url_for('item_page.index', url=request.authentication_request.item.url) }}"
            title="See item details"
          >
            {{ request.authentication_request.item.title }}
          </a>
          <a href="{{ url_for('authenticate_item_page.index', url=request.authentication_request.url) }}"
            title="View authentication request"
            class="badge mx-2 {% if request.authentication_request.status == 1 %}bg-warning
            {% elif request.authentication_request.status == 2 %}bg-success
            {% else %}bg-danger{% endif %} p-2"
          >
            {% if request.authentication_request.status == 1 %}
              Authentication Pending
            {% elif request.authentication_request.status == 2 %}
              Authenticated
            {% else %}
              Authentication Declined
            {% endif %}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No auctions to authenticate.</p>
      {% endif %}
  </div>

  <!-- General User Dashboard -->
  {% else %}
  <h1>User Dashboard</h1>
  {% endif %}

  <div class="container mt-5">
    <h2>Your Auctions</h2>
    {% if user['auctions'] %}
    <ul>
      {% for item in user['auctions'] %}
      <li>
        <a href="{{ url_for('item_page.index', url=item.url) }}" title="See item details">{{ item.title }}</a>
        {% if item.authentication_requests %}
          <a href="{{ url_for('authenticate_item_page.index', url=item.authentication_requests[0].url) }}" title="View authentication request" class="badge mx-2 {% if item.authentication_requests[0].status == 1 %}bg-warning{% elif item.authentication_requests[0].status == 2 %}bg-success{% elif item.authentication_requests[0].status == 3 %}bg-danger{% else %}bg-secondary{% endif %} p-2">
            {% if item.authentication_requests[0].status == 1 %}
              Authentication Pending
            {% elif item.authentication_requests[0].status == 2 %}
              Authenticated
            {% elif item.authentication_requests[0].status == 3 %}
              Authentication Declined
            {% else %}
              Not Authenticated
            {% endif %}
          </a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>No auctions available.</p>
    {% endif %}
  </div>

  <!-- Participated Auctions Section -->
  {% if current_user.role == 1 %}
  <div class="container mt-5">
    <h2>My Participated Auctions</h2>
    <!-- Tabs to switch between Bidding, Won, and Paid -->
    <ul class="nav nav-tabs" id="participatedTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="bidding-tab" data-bs-toggle="tab" href="#bidding" role="tab" aria-controls="bidding" aria-selected="true">Bidding</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="won-tab" data-bs-toggle="tab" href="#won" role="tab" aria-controls="won" aria-selected="false">Won</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="paid-tab" data-bs-toggle="tab" href="#paid" role="tab" aria-controls="paid" aria-selected="false">Paid</a>
      </li>
    </ul>

    <div class="tab-content mt-3" id="participatedTabsContent">
      <!-- Bidding Tab -->
      <div class="tab-pane fade show active" id="bidding" role="tabpanel" aria-labelledby="bidding-tab">
        {% if user.participated_auctions.bidding %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Item</th>
                <th>Status</th>
                <th>Current Price</th>
                <th>Time Remaining</th>
                <th>Watchers</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in user.participated_auctions.bidding %}
              <tr>
                <td><a href="{{ url_for('item_page.index', url=item.url) }}">{{ item.title }}</a></td>
                <td>
                  {% if item.status == 1 %}
                    <span class="badge bg-success">Open</span>
                  {% endif %}
                </td>
                <td>
                  {% set highest_bid = item.highest_bid() %}
                  {% if highest_bid %}
                    £{{ "%.2f"|format(highest_bid.bid_amount) }}
                  {% else %}
                    £{{ "%.2f"|format(item.minimum_price) }}
                  {% endif %}
                </td>
                <td>
                  {% if now < item.auction_end %}
                    <span class="countdown" data-end="{{ item.auction_end.isoformat() }}">
                      {{ item.auction_end.strftime('%Y-%m-%d %H:%M') }}
                    </span>
                  {% else %}
                    Ended
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-secondary">
                    <i class="fas fa-user-friends"></i> {{ item.watcher_count() }}
                  </span>
                </td>
                <td>
                  <a href="{{ url_for('item_page.index', url=item.url) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">You are not currently bidding on any auctions.</div>
        {% endif %}
      </div>

      <!-- Won Tab -->
      <div class="tab-pane fade" id="won" role="tabpanel" aria-labelledby="won-tab">
        {% if user.participated_auctions.won %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Item</th>
                <th>Status</th>
                <th>Winning Bid</th>
                <th>Time Ended</th>
                <th>Watchers</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in user.participated_auctions.won %}
              <tr>
                <td><a href="{{ url_for('item_page.index', url=item.url) }}">{{ item.title }}</a></td>
                <td><span class="badge bg-warning">Won</span></td>
                <td>
                  {% set highest_bid = item.highest_bid() %}
                  £{{ "%.2f"|format(highest_bid.bid_amount) }}
                </td>
                <td>
                  {{ item.auction_end.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td>
                  <span class="badge bg-secondary">
                    <i class="fas fa-user-friends"></i> {{ item.watcher_count() }}
                  </span>
                </td>
                <td>
                  <a href="{{ url_for('item_page.index', url=item.url) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View
                  </a>
                  <a href="{{ url_for('item_page.payment_page', url=item.url) }}" class="btn btn-sm btn-success">
                    <i class="fas fa-credit-card"></i> Pay
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">You haven't won any auctions yet.</div>
        {% endif %}
      </div>

      <!-- Paid Tab -->
      <div class="tab-pane fade" id="paid" role="tabpanel" aria-labelledby="paid-tab">
        {% if user.participated_auctions.paid %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Item</th>
                <th>Status</th>
                <th>Winning Bid</th>
                <th>Time Ended</th>
                <th>Watchers</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in user.participated_auctions.paid %}
              <tr>
                <td><a href="{{ url_for('item_page.index', url=item.url) }}">{{ item.title }}</a></td>
                <td><span class="badge bg-info">Paid</span></td>
                <td>
                  {% set highest_bid = item.highest_bid() %}
                  £{{ "%.2f"|format(highest_bid.bid_amount) }}
                </td>
                <td>
                  {{ item.auction_end.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td>
                  <span class="badge bg-secondary">
                    <i class="fas fa-user-friends"></i> {{ item.watcher_count() }}
                  </span>
                </td>
                <td>
                  <a href="{{ url_for('item_page.index', url=item.url) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">You haven't paid for any auctions yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}


  <!-- Watched Auction Table -->
  <div class="container mt-5">
    <h2>My Watched Auctions</h2>
    {% if user['watched_items'] %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Item</th>
              <th>Status</th>
              <th>Current Price</th>
              <th>Time Remaining</th>
              <th>Watchers</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in user['watched_items'] %}
            <tr>
              <td>{{ item.title }}</td>
              <td>
                {% if now < item.auction_end %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Ended</span>
                {% endif %}
              </td>
              <td>
                {% set highest_bid = item.highest_bid() %}
                {% if highest_bid %}
                  £{{ "%.2f"|format(highest_bid.bid_amount) }}
                {% else %}
                  £{{ "%.2f"|format(item.minimum_price) }}
                {% endif %}
              </td>
              <td>
                {% if now < item.auction_end %}
                  <span class="countdown" data-end="{{ item.auction_end.isoformat() }}">
                    {{ item.auction_end.strftime('%Y-%m-%d %H:%M') }}
                  </span>
                {% else %}
                  Ended
                {% endif %}
              </td>
              <td>
                <span class="badge bg-secondary">
                  <i class="fas fa-user-friends"></i> {{ item.watcher_count() }}
                </span>
              </td>
              <td>
                <div class="btn-group d-flex gap-1">
                  <a href="{{ url_for('item_page.index', url=item.url) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View
                  </a>
                  <button class="btn btn-sm btn-outline-danger unwatch-btn" data-item-url="{{ item.url }}">
                    <i class="fas fa-times"></i> Unwatch
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        <p>You are not watching any auctions. Browse active auctions to find items to watch!</p>
        <a href="{{ url_for('home_page.index') }}" class="btn btn-primary">Browse Auctions</a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Custom Scripts -->
<script src="{{ url_for('static', filename='js/updateRole.js') }}"></script>
<script src="{{ url_for('static', filename='js/updateConfig.js') }}"></script>
<script src="{{ url_for('static', filename='js/assignExpert.js') }}"></script>
<script src="{{ url_for('static', filename='js/managementCharts.js') }}"></script>
<script src="{{ url_for('static', filename='js/changeExpertise.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
