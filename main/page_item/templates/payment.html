{% extends "base.html" %}

{% block title %}Payment for {{ item.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>Payment for {{ item.title }}</h2>
  <p>Your winning bid: Â£{{ "%.2f"|format(item.highest_bid().bid_amount if item.highest_bid() else item.minimum_price) }}</p>
  <form id="payment-form">
    <!-- Stripe will inject the Payment Element here -->
    <div id="payment-element"></div>
    <button id="submit" class="btn btn-primary mt-3">Pay Now</button>
    <div id="payment-message" role="alert" class="mt-3 text-danger"></div>
  </form>
</div>

<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Initialize Stripe with the publishable key passed from your route.
  const stripe = Stripe("{{ stripe_publishable_key }}");

  // Retrieve the CSRF token from the meta tag
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  let elements;

  // Initialize the Payment Element on page load.
  initialize();

  // Attach event listener to the correct button id ("submit")
  document.getElementById('submit').addEventListener('click', handleSubmit);

  async function initialize() {
    // Create the PaymentIntent on your server.
    const response = await fetch("{{ url_for('item_page.create_payment_intent', url=item.url) }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      }
    });
    const { clientSecret, error } = await response.json();
    if (error) {
      document.getElementById("payment-message").innerText = error;
      return;
    }

    // Initialize Stripe Elements with the clientSecret.
    elements = stripe.elements({ clientSecret });
    const paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const { error: submitError } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        // Optionally, you can set a return_url to redirect after payment
        return_url: "{{ url_for('item_page.index', url=item.url, _external=True) }}"
      }
    });
    if (submitError) {
      document.getElementById("payment-message").innerText = submitError.message;
    }
  }
</script>
{% endblock %}
