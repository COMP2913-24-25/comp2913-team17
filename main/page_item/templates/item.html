{% extends "base.html" %}

{% block title %}Auction: {{ item.title }}{% endblock %}

{% block content %}

<div class="container mt-5">
  <div class="row">
    <!-- Image Column -->
    <div class="col-md-6 mb-4">
      {% if item.image %}
      <img src="{{ item.image }}" 
        alt="{{ item.title }}" 
        class="img-fluid rounded"
        loading="lazy"
      >
      {% else %}
      <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 400px">
        <p class="text-muted">No image available</p>
      </div>
      {% endif %}
    </div>
    <!-- Details Column -->
    <div class="col-md-6">
      <h1 class="mb-2">{{ item.title }}</h1>
      <!-- Category Badge -->
      <div class="mb-2">
        <span class="badge bg-info p-2" {% if item.category.description %}title="{{ item.category.description }}"{% endif %}>
          <i class="fas fa-tag"></i> {{ item.category.name }}
        </span>
      </div>
      <!-- Auction Status -->
      <div class="mb-4">
        <h5>Auction Status</h5>
        <div class="d-flex gap-3">
          <span class="badge {% if item.locked %}bg-danger{% else %}bg-success{% endif %} p-2">
            {{ "Locked" if item.locked else "Open" }}
          </span>
          {% if is_allowed %}
          <a href="{{ url_for('authenticate_item_page.index', url=item.authentication_requests[0].url) }}"
            title="View authentication request"
            class="badge mx-2 {% if item.authentication_requests[0].status == 1 %}bg-warning
            {% elif item.authentication_requests[0].status == 2 %}bg-success
            {% else %}bg-danger{% endif %} p-2"
          >
            {% if item.authentication_requests[0].status == 1 %}
              Authentication Pending
            {% elif item.authentication_requests[0].status == 2 %}
              Authenticated
            {% else %}
              Authentication Declined
            {% endif %}
          </a>
          {% else %}
          <span class="badge {% if authentication == 1 %}bg-warning
            {% elif item.authentication == 2 %}bg-success
            {% elif authentication == 3 %}bg-danger
            {% else %}bg-secondary{% endif %} p-2"
          >
            {% if authentication == 1 %}
              Authentication Pending
            {% elif authentication == 2 %}
              Authenticated
            {% elif authentication == 3 %}
              Authentication Declined
            {% else %}
              Not Authenticated
            {% endif %}
          </span>
          {% endif %}
        </div>
      </div>
      <!-- Price -->
      <div class="mb-4" id="price-section">
        {% if item.highest_bid() %}
        <h5>Highest Bid</h5>
        <p class="h3 text-primary">£{{ "%.2f"|format(item.highest_bid().bid_amount) }}</p>
        {% else %}
        <h5>Starting Price</h5>
        <p class="h3 text-primary">£{{ "%.2f"|format(item.minimum_price) }}</p>
        {% endif %}
      </div>
      <!-- Auction Times -->
      <div class="mb-4">
        <h5>Auction Period</h5>
        <div class="row">
          <div class="col">
            <small class="text-muted">Start Time</small>
            <p>{{ item.auction_start.strftime('%Y-%m-%d %H:%M') }}</p>
          </div>
          <div class="col">
            <small class="text-muted">End Time</small>
            <p class="auction-end">{{ item.auction_end.strftime('%Y-%m-%d %H:%M') }}</p>
            <p><span class="countdown-label">Time remaining:</span> <span class="countdown" data-end="{{ item.auction_end.isoformat() }}">{{ item.auction_end.strftime('%Y-%m-%d %H:%M') }}</span></p>
          </div>
        </div>
      </div>
      <!-- Description -->
      <div class="mb-4">
        <h5>Description</h5>
        <p class="text-break">{{ item.description }}</p>
      </div>
      <!-- Seller Info -->
      <div class="mb-4">
        <h5>Seller Information</h5>
        <p>Posted by: {{ item.seller.username }}</p>
        <p><small class="text-muted">Upload date: {{ item.upload_date.strftime('%Y-%m-%d %H:%M') }}</small></p>
      </div>
      <!-- Action Buttons -->
      {% if current_user.is_authenticated %}
      <form action="{{ url_for('item_page.place_bid', url=item.url) }}" method="POST" class="bid-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
          <label for="bid_amount" class="form-label">Your Bid Amount</label>
          <div class="input-group">
            <span class="input-group-text">£</span>
            <input 
              type="number"
              class="form-control"
              id="bid_amount"
              name="bid_amount"
              step="0.01"
              min="{{ suggested_bid }}"
              value="{{ suggested_bid }}"
              required
            >
          </div>
          <div class="form-text" id="bid-amount-help">
            {% if item.highest_bid() %}
              Current highest bid: £<span class="max-bid">{{ "%.2f"|format(item.highest_bid().bid_amount) }}</span>
            {% else %}
              Minimum bid: £{{ "%.2f"|format(item.minimum_price) }}
            {% endif %}
          </div>
        </div>
        
        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary btn-lg">Place Bid</button>
        </div>
        
        <div class="mt-3 d-flex align-items-center">
          {% if is_watching %}
            <button id="unwatch-btn" class="btn btn-success" data-item-url="{{ item.url }}">
              <i class="fas fa-check"></i> Watched
            </button>
          {% else %}
            <button id="watch-btn" class="btn btn-outline-primary" data-item-url="{{ item.url }}">
              <i class="fas fa-eye"></i> Watch
            </button>
          {% endif %}
          <span id="watch-counter" class="ms-2 badge bg-secondary">
            <i class="fas fa-user-friends"></i> {{ item.watcher_count() }} {% if item.watcher_count() == 1 %}watcher{% else %}watchers{% endif %}
          </span>
        </div>
        
        <div class="mt-3">
          <p class="text-muted small-end">
            Auction ends on: {{ item.auction_end.strftime('%B %d, %Y at %I:%M %p') }}
          </p>
          {% if item.highest_bid() and item.highest_bid().bidder_id == current_user.id %}
            <div class="alert alert-info mt-2 max-bid-alert">
              You currently have the highest bid!
            </div>
          {% endif %}
          <h3>Bid History:</h3>
          {% if bids %}
          <ol class="bid-history" reversed start="{{ bids|length }}">
            {% for bid in bids %}
            <li>
              {{ bid.bidder.username }}</strong> - £{{ "%.2f"|format(bid.bid_amount) }}
              <small class="text-muted">({{ bid.bid_time.strftime('%Y-%m-%d %H:%M') }})</small>
            </li>
            {% endfor %}
          </ol>
          {% else %}
          <p class="text-muted no-bids-msg">No bids yet</p>
          {% endif %}
        </div>
      </form>
      {% else %}
      <div class="d-grid gap-2">
        <a href="{{ url_for('auth_page.login') }}" class="btn btn-primary btn-lg">Login to Place Bid</a>
      </div>
      {% endif %}

      <!-- Payment Section (Only visible if the auction is over and the current user is the winner) -->
      <!-- Payment Section (Only visible if the auction is over and the current user is the winner) -->
      {% if show_payment %}
      <hr>
      <div id="payment-section">
        <h3>Payment</h3>
        <p>Your winning bid: £{{ "%.2f"|format(item.highest_bid().bid_amount if item.highest_bid() else item.minimum_price) }}</p>
        <a href="{{ url_for('item_page.payment_page', url=item.url) }}" class="btn btn-primary">Make Payment</a>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='js/bidding.js') }}"></script>
<script src="{{ url_for('static', filename='js/watchAuction.js') }}"></script>

{% endblock %}